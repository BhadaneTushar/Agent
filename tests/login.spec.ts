import { test, expect } from '@playwright/test';
import { LoginPage } from '../pages/LoginPage';
import { validData, invalidData, boundaryData, malformedEmails } from '../test-data/login.data';

/**
 * Super Admin Login Tests â€” EAEU-2
 * 
 * Covers acceptance criteria: AC1, AC2, AC3, AC4, AC5, AC7
 * Generated by Tushar ðŸŽ¯ â€” Senior SDET Agent
 */

const BASE_URL = 'https://qa.admin.eu.eamata.com';

test.describe('EAEU-2: Super Admin Login @jira-EAEU-2', () => {
    let loginPage: LoginPage;

    test.beforeEach(async ({ page }) => {
        loginPage = new LoginPage(page, BASE_URL);
        await loginPage.goto();
    });

    // ===================================================================
    // AC1: Login Page Accessibility
    // ===================================================================

    test.describe('AC1: Login Page Accessibility', () => {
        test('TC-01: Login page loads with email and password fields @smoke @regression', async () => {
            // AC-01 | P1 | Positive
            await loginPage.verifyPageLoaded();
            await loginPage.verifyPageTitle();
        });

        test('TC-02: Login page URL is correct @regression', async () => {
            // AC-01 | P2 | Positive
            await loginPage.verifyOnLoginPage();
        });

        test('TC-03: Login page is served over HTTPS @smoke @regression', async () => {
            // AC-01 â†’ AC5 | P0 | Security
            await loginPage.verifyHTTPS();
        });

        test('TC-04: Password field is masked by default @regression', async () => {
            // AC-01 â†’ AC5 | P1 | Security
            await loginPage.verifyPasswordMasked();
        });

        test('TC-05: Login button is visible @regression', async () => {
            // AC-01 | P2 | Positive
            await expect(loginPage.loginButton).toBeVisible();
        });
    });

    // ===================================================================
    // AC2: Credentials Validation
    // ===================================================================

    test.describe('AC2: Credentials Validation', () => {
        test('TC-06: Login fails with non-existent email @regression', async () => {
            // AC-02 | P1 | Negative
            const data = invalidData('wrong_email');
            await loginPage.login(data.email, data.password);
            await loginPage.verifyErrorMessage();
            await loginPage.verifyOnLoginPage();
        });

        test('TC-07: Login fails with incorrect password @regression', async () => {
            // AC-02 | P1 | Negative
            const data = invalidData('wrong_password');
            await loginPage.login(data.email, data.password);
            await loginPage.verifyErrorMessage();
            await loginPage.verifyOnLoginPage();
        });

        test('TC-08: Login fails with both wrong email and password @regression', async () => {
            // AC-02 | P2 | Negative
            const data = invalidData('both_wrong');
            await loginPage.login(data.email, data.password);
            await loginPage.verifyErrorMessage();
            await loginPage.verifyOnLoginPage();
        });
    });

    // ===================================================================
    // AC3: Successful Login
    // ===================================================================

    test.describe('AC3: Successful Login', () => {
        test('TC-09: Super Admin can login with valid credentials @smoke @regression', async () => {
            // AC-03 | P0 | Positive â€” Critical Path
            const data = validData();
            await loginPage.login(data.email, data.password);
            await loginPage.verifyLoginSuccess();
        });

        test('TC-10: Super Admin is redirected to admin home after login @smoke @regression', async () => {
            // AC-03 | P0 | Positive
            const data = validData();
            await loginPage.login(data.email, data.password);
            // Verify redirected away from login page
            await expect(loginPage.page).not.toHaveURL(/\/auth\/login/, { timeout: 15000 });
        });
    });

    // ===================================================================
    // AC4: Error Handling
    // ===================================================================

    test.describe('AC4: Error Handling', () => {
        test('TC-11: Clear error message shown for invalid credentials @regression', async () => {
            // AC-04 | P1 | Negative
            const data = invalidData('wrong_password');
            await loginPage.login(data.email, data.password);
            // Verify an error message appears (e.g., "Invalid email or password")
            await loginPage.verifyErrorMessage();
        });

        test('TC-12: Error message for empty email field @regression', async () => {
            // AC-04 | P2 | Validation
            const data = boundaryData('empty_email');
            if (data.email === '') {
                await loginPage.fillPassword(data.password);
                await loginPage.clickLogin();
            } else {
                await loginPage.login(data.email, data.password);
            }
            // Should show validation or remain on login
            await loginPage.verifyOnLoginPage();
        });

        test('TC-13: Error message for empty password field @regression', async () => {
            // AC-04 | P2 | Validation
            const data = boundaryData('empty_password');
            await loginPage.fillEmail(data.email);
            await loginPage.clickLogin();
            await loginPage.verifyOnLoginPage();
        });

        test('TC-14: Error message for both fields empty @regression', async () => {
            // AC-04 | P2 | Validation
            await loginPage.clickLogin();
            await loginPage.verifyOnLoginPage();
        });
    });

    // ===================================================================
    // AC5: Security Measures
    // ===================================================================

    test.describe('AC5: Security Measures', () => {
        test('TC-15: Password toggle shows/hides password @regression', async ({ page }) => {
            // AC-05 | P2 | Security
            await loginPage.fillPassword('TestPassword123');
            // Initially masked
            await loginPage.verifyPasswordMasked();
            // Toggle to visible â€” try clicking if toggle exists
            try {
                await loginPage.togglePasswordVisibility();
                await loginPage.verifyPasswordVisible();
                // Toggle back
                await loginPage.togglePasswordVisibility();
                await loginPage.verifyPasswordMasked();
            } catch {
                // If toggle button not found, just verify password stays masked
                await loginPage.verifyPasswordMasked();
            }
        });

        test('TC-16: SQL injection in email does not bypass authentication @regression', async () => {
            // AC-05 | P0 | Security â€” Critical
            const data = boundaryData('sql_injection');
            await loginPage.login(data.email, data.password);
            await loginPage.verifyOnLoginPage();
        });

        test('TC-17: XSS payload in email is sanitized @regression', async () => {
            // AC-05 | P0 | Security â€” Critical
            const data = boundaryData('xss');
            await loginPage.login(data.email, data.password);
            // Verify no script executed â€” page still on login
            await loginPage.verifyOnLoginPage();
            // Verify no alert dialogs
            const page = loginPage.page;
            let dialogAppeared = false;
            page.on('dialog', () => { dialogAppeared = true; });
            expect(dialogAppeared).toBe(false);
        });

        test('TC-18: Whitespace-only inputs do not authenticate @regression', async () => {
            // AC-05 | P1 | Edge Case
            const data = boundaryData('whitespace');
            await loginPage.login(data.email, data.password);
            await loginPage.verifyOnLoginPage();
        });
    });

    // ===================================================================
    // Edge Cases & Boundary
    // ===================================================================

    test.describe('Edge Cases & Boundary', () => {
        test('TC-19: Malformed email formats are rejected @regression', async () => {
            // AC-02 | P2 | Edge Case
            const emails = malformedEmails();
            for (const email of emails) {
                await loginPage.goto();
                await loginPage.fillEmail(email);
                await loginPage.fillPassword('SomePassword123');
                await loginPage.clickLogin();
                // Should stay on login page or show validation
                await loginPage.verifyOnLoginPage();
            }
        });

        test('TC-20: Max length input in email field @regression', async () => {
            // AC-02 | P3 | Boundary
            const data = boundaryData('max_length');
            await loginPage.login(data.email, data.password);
            await loginPage.verifyOnLoginPage();
        });

        test('TC-21: Special characters in password @regression', async () => {
            // AC-02 | P3 | Boundary
            const data = boundaryData('special_chars');
            await loginPage.login(data.email, data.password);
            await loginPage.verifyOnLoginPage();
        });
    });

    // ===================================================================
    // AC7: Session Management
    // ===================================================================

    test.describe('AC7: Session Management', () => {
        test('TC-22: User remains on dashboard after page refresh @regression', async ({ page }) => {
            // AC-07 | P1 | Session
            const data = validData();
            await loginPage.login(data.email, data.password);
            await loginPage.verifyLoginSuccess();
            // Refresh page
            await page.reload();
            await page.waitForLoadState('networkidle');
            // Should NOT be redirected back to login
            await expect(page).not.toHaveURL(/\/auth\/login/);
        });

        test('TC-23: Multiple rapid login attempts do not create duplicate sessions @regression', async () => {
            // AC-07 | P1 | Concurrency/Duplicate
            const data = validData();
            // Rapid double-click on login
            await loginPage.fillEmail(data.email);
            await loginPage.fillPassword(data.password);
            await loginPage.loginButton.dblclick();
            await loginPage.page.waitForLoadState('networkidle');
            // Should still redirect properly without errors
            await expect(loginPage.page).not.toHaveURL(/\/auth\/login/, { timeout: 15000 });
        });
    });
});
